# TM Robot Modbus 測試工具 - 專案規格文件

## 📋 專案資訊

**專案名稱**: TM Robot Modbus 測試工具 (TM Robot Modbus Testkit)  
**版本**: v1.0.1.0001  
**目標用戶**: 高級測試員  
**開發語言**: Python 3  
**最後更新**: 2026-02-09

---

## 🎯 專案目標

開發一套完整的 Modbus TCP 測試工具，用於測試和驗證 **TMflow 程式的 Modbus 功能**，確認其讀寫操作是否符合 TM Robot Modbus 規範。包含座標讀取、狀態監控、性能測試和自定義測試功能。

### 測試目的
- ✅ 驗證 TMflow 的 Modbus 讀取功能是否正確
- ✅ 驗證 TMflow 的 Modbus 寫入功能是否正確
- ✅ 確認數據格式符合規範 (Float32, Int16, Bool 等)
- ✅ 測試通訊性能和穩定性
- ✅ 驗證各種 Modbus 功能碼的實作

---

## 🏗️ 系統架構

### 核心組件

1. **tmflow_modbus_testkit.py** - 主測試工具 (GUI)
   - 圖形化使用者介面
   - Modbus TCP 客戶端
   - 測試功能實作
   - 性能測試引擎
   - **直接連線到 TMflow 程式進行測試**

2. **simulator.py** - Modbus 模擬器 (開發輔助工具)
   - 僅用於開發階段測試
   - 模擬 TMflow 的 Modbus 行為
   - **實際使用時不需要模擬器**

3. **啟動測試工具.bat** - 快速啟動腳本
   - 一鍵啟動測試工具

---

## 💻 技術棧

### 開發環境
- **Python**: 3.7+
- **作業系統**: Windows (主要), Linux/macOS (支援)

### 核心依賴庫
```
pymodbus >= 3.0.0    # Modbus TCP 通訊庫
tkinter              # GUI 框架 (Python 內建)
```

### 標準庫
- `struct` - 數據格式轉換 (Float32, Int32 等)
- `threading` - 多線程支援 (性能測試、連續監控)
- `time` - 時間控制和延遲
- `datetime` - 時間戳記錄
- `asyncio` - 異步伺服器 (模擬器)
- `logging` - 日誌記錄 (模擬器)
- `random` - 隨機數生成 (模擬器延遲)

---

## ✨ 功能規格

### 1. 連線管理

#### 1.1 連線設定
- **IP 位址輸入**: 支援 IPv4 格式
- **Port 設定**: 預設 502 (Modbus 標準)
- **Slave ID**: 固定為 1
- **連線狀態顯示**: 即時顯示連線狀態 (🟢已連線 / 🔴未連線)

#### 1.2 連線操作
- **連線按鈕**: 建立 Modbus TCP 連線
- **斷線按鈕**: 中斷連線並清理資源
- **自動重連**: 不支援 (需手動重連)
- **連線超時**: 3 秒

---

### 2. 預設測試功能

#### 2.1 Base 座標測試
- **Modbus 位址**: 7001-7012 (Input Registers)
- **功能碼**: 04 (Read Input Registers)
- **數據格式**: Float32 (每個座標佔用 2 個 registers)
- **讀取內容**:
  - X, Y, Z 位置 (mm)
  - Rx, Ry, Rz 旋轉角度 (度)

#### 2.2 Tool 座標測試
- **Modbus 位址**: 7025-7036 (Input Registers)
- **功能碼**: 04
- **數據格式**: Float32
- **讀取內容**: 同 Base 座標

#### 2.3 Joint 角度測試
- **Modbus 位址**: 7013-7024 (Input Registers)
- **功能碼**: 04
- **數據格式**: Float32
- **讀取內容**: Joint 1-6 的角度 (度)

#### 2.4 Robot 狀態測試
- **Discrete Inputs** (功能碼 02):
  - 7200: Robot Link (機器人連線狀態)
  - 7201: Error (錯誤狀態)
  - 7202: Project Running (專案運行狀態)
  - 7208: ESTOP (緊急停止狀態)

- **Input Registers** (功能碼 04):
  - 7215: Robot State (機器人狀態碼)
  - 7216: Operation Mode (操作模式)

#### 2.5 User Define Area 測試
- **Modbus 位址**: 9000-9999 (Holding Registers)
- **功能碼**: 03 (讀取), 06 (寫入單一), 16 (寫入多個)
- **功能**:
  - 讀取自定義區域數據
  - 寫入測試值
  - 讀寫驗證

#### 2.6 全部測試
- 依序執行: Base → Joint → Tool → Status
- 每個測試間隔 200ms
- 完整測試報告

#### 2.7 連續監控
- 每 5 秒執行一次全部測試
- 背景執行 (多線程)
- 可隨時停止

---

### 3. 自定義測試功能

#### 3.1 功能碼選擇
- **Coils (01)**: 讀取線圈狀態
- **Discrete Inputs (02)**: 讀取離散輸入
- **Holding Registers (03)**: 讀取保持寄存器
- **Input Registers (04)**: 讀取輸入寄存器

#### 3.2 測試參數
- **起始位址**: 0-65535
- **數量**: 1-125 (registers) / 1-2000 (bits)
- **Slave ID**: 1-247
- **測試名稱**: 自定義描述

#### 3.3 數據型別支援
- **Bool**: 布林值
- **Int16**: 有符號 16-bit 整數
- **UInt16**: 無符號 16-bit 整數
- **Int32**: 有符號 32-bit 整數 (佔用 2 registers)
- **UInt32**: 無符號 32-bit 整數 (佔用 2 registers)
- **Float32**: 32-bit 浮點數 (佔用 2 registers)
- **Raw**: 原始 register 值

#### 3.4 快速預設
- **Base座標**: 7001, 12, Float32
- **Tool座標**: 7025, 12, Float32
- **Joint角度**: 7013, 12, Float32
- **Robot狀態**: 7200, 4, Bool (Discrete Inputs)
- **Light控制**: 7206, 1, Bool (Coils)
- **UserDefine**: 9000, 10, UInt16

---

### 4. 性能測試功能

#### 4.1 測試類型
1. **Base座標讀取**: 測試 7001-7012 讀取性能
2. **Tool座標讀取**: 測試 7025-7036 讀取性能
3. **Joint角度讀取**: 測試 7013-7024 讀取性能
4. **Robot狀態讀取**: 測試 7200-7203 讀取性能
5. **User Define讀取**: 測試 9000-9009 讀取性能
6. **User Define寫入**: 測試 9000 寫入性能
7. **User Define讀寫**: 測試讀寫組合操作
8. **混合測試**: 組合多種操作
9. **極限測試**: 最小數據量的極限測試

#### 4.2 測試參數
- **測試次數**: 1-100,000 次
  - 快速選擇: 50, 100, 500, 1K, 5K
- **測試間隔**: 0-60,000 ms
  - 快速選擇: 0, 1, 10, 100, 1K
  - 0ms = 極限測試模式 (無間隔)

#### 4.3 即時統計
- **進度顯示**: 進度條 + 數字 (當前/總數)
- **平均時間**: 所有測試的平均反應時間 (ms)
- **最小時間**: 最快的反應時間 (ms)
- **最大時間**: 最慢的反應時間 (ms)
- **成功率**: 成功測試的百分比 (%)

#### 4.4 測試報告
- **基本統計**: 平均、最小、最大、成功率
- **進階統計**: 95% 百分位數、標準差
- **詳細數據**: 每次測試的時間戳和結果
- **報告格式**: 純文字檔 (.txt)
- **檔名格式**: `tm_robot_performance_report_YYYYMMDD_HHMMSS.txt`

#### 4.5 性能評估標準
- **優秀**: 平均反應時間 < 5ms
- **良好**: 平均反應時間 < 10ms
- **需優化**: 平均反應時間 >= 10ms

---

### 5. 日誌管理

#### 5.1 日誌顯示
- **即時顯示**: 所有操作即時記錄
- **時間戳**: 精確到秒 (HH:MM:SS)
- **等級圖示**:
  - ℹ️ INFO: 一般資訊
  - ✅ SUCCESS: 成功操作
  - ⚠️ WARNING: 警告訊息
  - ❌ ERROR: 錯誤訊息
- **自動捲動**: 自動捲動到最新日誌
- **字型**: Consolas 10pt (等寬字型)

#### 5.2 日誌操作
- **清除日誌**: 清空顯示區域
- **儲存日誌**: 儲存到檔案
- **檔名格式**: `tm_robot_test_log_YYYYMMDD_HHMMSS.txt`
- **編碼**: UTF-8

---

### 6. 使用者介面

#### 6.1 視窗配置
- **視窗標題**: "🤖 TM Robot 座標測試工具 v1.0.1.0001"
- **視窗大小**: 1100x800 像素
- **佈局**: 上下分割
  - 上方: 連線設定
  - 中間: 測試功能區 (左右分割)
    - 左側: 預設測試 + 日誌顯示
    - 右側: 自定義測試 + 性能測試
  - 下方: 狀態列

#### 6.2 滾動支援
- **垂直滾動**: 支援
- **水平滾動**: 支援
- **滑鼠滾輪**: 支援

#### 6.3 按鈕設計
- **圖示**: 使用 Emoji 圖示增加辨識度
- **寬度**: 統一 12 字元寬
- **狀態**: 根據連線狀態啟用/停用

---

## 📋 TMflow Modbus 規範驗證

### 測試項目清單

#### 1. 座標讀取驗證
- ✅ **Base 座標 (7001-7012)**: 驗證 X, Y, Z, Rx, Ry, Rz 的 Float32 格式
- ✅ **Tool 座標 (7025-7036)**: 驗證 Tool 座標的 Float32 格式
- ✅ **Joint 角度 (7013-7024)**: 驗證 6 軸關節角度的 Float32 格式

#### 2. 狀態讀取驗證
- ✅ **Discrete Inputs (功能碼 02)**: 驗證 7200, 7201, 7202, 7208
- ✅ **Input Registers (功能碼 04)**: 驗證 7215, 7216

#### 3. User Define Area 驗證
- ✅ **讀取功能 (功能碼 03)**: 驗證 9000-9999 讀取
- ✅ **寫入功能 (功能碼 06)**: 驗證單一 register 寫入
- ✅ **讀寫驗證**: 寫入後讀取確認數值正確

#### 4. 性能驗證
- ✅ **反應時間**: 測試 TMflow 的 Modbus 反應速度
- ✅ **穩定性**: 大量測試確認通訊穩定性
- ✅ **成功率**: 驗證通訊成功率是否達標

### 規範符合性檢查
- **數據格式**: Float32 使用 Big-Endian (>f) 格式
- **Register 順序**: 高位元組在前 (>HH)
- **位址範圍**: 符合 TM Robot Modbus 位址表
- **功能碼**: 正確實作 01, 02, 03, 04, 06 功能碼

---

## 🔧 Modbus 模擬器 (開發輔助工具)

> **注意**: 模擬器僅用於開發階段，實際測試時直接連線到 TMflow 程式。

### 模擬器用途
- 開發階段測試工具功能
- 無 TMflow 環境時的功能驗證
- 模擬各種 Modbus 回應情境

### 模擬器特性
- 模擬 TMflow 的 Modbus 行為
- 提供測試用的座標和狀態數據
- 支援真實延遲模擬 (5-20ms)

---

## 📁 檔案結構

```
Modbus-testkit-for-TMflow/
├── tmflow_modbus_testkit.py      # 主測試工具
├── simulator.py                   # Modbus 模擬器（開發用）
├── requirements.txt               # Python 依賴
├── 啟動測試工具.bat               # Windows 啟動腳本
├── README.md                      # 專案說明
├── 專案規格文件.md                # 本文件（完整技術規格）
├── 使用說明.txt                   # 詳細使用說明
├── 功能說明.txt                   # 功能詳細說明
├── .gitignore                     # Git 忽略規則
└── tm_robot_test_log_*.txt       # 測試日誌（自動生成，不上傳）
```

---

## 🚀 使用流程

### 測試 TMflow 的標準流程

#### 前置準備
1. **確保 TMflow 程式正在運行**
   - TMflow 必須已啟動並開啟 Modbus 功能
   - 確認 TMflow 的 Modbus TCP Server 已啟用
   - 記下 TMflow 所在電腦的 IP 位址

2. **啟動測試工具**
   ```bash
   python tmflow_modbus_testkit.py
   # 或雙擊 啟動測試工具.bat
   ```

#### 測試步驟
3. **連線到 TMflow**
   - 輸入 TMflow 的 IP 位址 (例如: 192.168.1.100)
   - 輸入 Port: 502 (Modbus 標準 Port)
   - 點擊「連線」按鈕
   - 確認狀態列顯示 🟢 已連線

4. **執行功能測試**
   - **Base 座標測試**: 驗證 TMflow 回傳的 Base 座標是否正確
   - **Tool 座標測試**: 驗證 Tool 座標讀取功能
   - **Joint 角度測試**: 驗證關節角度讀取功能
   - **Robot 狀態測試**: 驗證狀態位元讀取功能
   - **User Define 測試**: 驗證自定義區域的讀寫功能

5. **執行性能測試**
   - 測試 TMflow 的 Modbus 反應速度
   - 驗證通訊穩定性
   - 生成性能測試報告

6. **查看測試結果**
   - 日誌區域顯示所有測試結果
   - 確認數據格式是否符合規範
   - 儲存日誌作為測試證明

### 性能測試流程 (驗證 TMflow 性能)
1. 選擇測試類型 (例如: Base座標讀取)
2. 設定測試次數 (建議 100-1000 次)
3. 設定測試間隔 (建議 10-100ms)
4. 點擊「🚀 開始測試」
5. 觀察即時統計數據
6. 測試完成後點擊「📈 生成報告」
7. 檢查報告確認 TMflow 性能是否符合要求

### 測試報告用途
- 作為 TMflow Modbus 功能的驗證證明
- 記錄 TMflow 的性能指標
- 提供給客戶或內部品質管理

---

## 🔒 安全性考量

### 網路安全
- **連線超時**: 3 秒防止長時間等待
- **錯誤處理**: 完整的異常捕獲和處理
- **資源清理**: 斷線時正確關閉連線

### 輸入驗證
- **測試次數**: 限制 1-100,000
- **測試間隔**: 限制 0-60,000ms
- **位址範圍**: 0-65535
- **數值格式**: 即時驗證輸入格式

---

## 📊 性能指標

### 目標性能
- **連線建立**: < 3 秒
- **單次讀取**: < 50ms (正常網路)
- **極限測試**: < 10ms (本機模擬器)
- **GUI 響應**: < 100ms

### 測試容量
- **最大測試次數**: 100,000 次
- **最大監控時間**: 無限制 (可手動停止)
- **最大日誌大小**: 無限制 (建議定期清除)

---

## 🐛 已知限制

1. **不支援自動重連**: 斷線後需手動重連
2. **單一 Slave ID**: 固定為 1，不支援多 Slave
3. **GUI 凍結**: 大量測試時可能短暫凍結 (使用多線程緩解)
4. **記憶體使用**: 大量測試結果會佔用記憶體
5. **Windows 優化**: 主要針對 Windows 平台優化

---

## 🔮 未來擴展

### 短期計劃
- [ ] 支援多 Slave ID 切換
- [ ] 自動重連功能
- [ ] 測試腳本錄製和回放
- [ ] 圖表化性能分析

### 長期計劃
- [ ] 支援 Modbus RTU
- [ ] 資料庫記錄測試歷史
- [ ] Web 介面版本
- [ ] 自動化測試排程

---

## 📚 參考文件

1. **TM Robot 官方文件**
   - Programming Language TMscript_2.24_Rev1.0_EN.pdf
   - Software Manual TMflow_SW2.24_Rev1.00E_EN.pdf

2. **Modbus 協定**
   - Modbus Application Protocol Specification V1.1b3
   - Modbus Messaging on TCP/IP Implementation Guide V1.0b

3. **Python 庫文件**
   - pymodbus: https://pymodbus.readthedocs.io/
   - tkinter: https://docs.python.org/3/library/tkinter.html

---

## 📝 版本歷史

### v1.0.1.0001 (2026-02-09)
- ✅ 完整的 GUI 測試工具
- ✅ Modbus 模擬器
- ✅ 預設測試功能 (Base, Tool, Joint, Status, User Define)
- ✅ 自定義測試功能
- ✅ 性能測試功能
- ✅ 日誌管理
- ✅ 連續監控
- ✅ 測試報告生成

---

## 👥 開發團隊

**目標用戶**: 高級測試員  
**開發平台**: Windows  
**測試環境**: Python 3.7+, pymodbus 3.0+

---

## 📄 授權

本專案為內部測試工具，僅供授權人員使用。

---

**文件版本**: 1.0  
**最後更新**: 2026-02-09  
**維護者**: TM Robot 測試團隊
